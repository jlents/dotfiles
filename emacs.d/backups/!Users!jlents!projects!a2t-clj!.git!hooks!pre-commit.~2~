#!/bin/sh

##   LIST OF DIRECTORIES OMITTED FOR TRAILING WHITESPACE INSPECTION
#    anything in .git directory
#    anything in target directory
#    anything in bower_components
#    anything in resources/ingest-files
#    anything in resources/certs
#    anything in an img directory
#    anything in an npm directory

##   LIST OF FILE EXTENSIONS OMITTED FOR TRAILING WHITESPACE INSPECTION
#    .pptx
#    .png
#    .jpg
#    .gif
#    .pdf

for FILE in `find . -type f -not -path "./.git/*" -not -path "./target/*" -not -path "*/bower_components/*" -not -path "*/resources/ingest-files/*" -not -path "*/resources/certs/*" -not -path "*/img/*" -not -path "*/npm/*" -not -path "*.pptx" -not -path "*.png" -not -path ".jpg" -not -path ".gif" -not -path ".pdf" -exec egrep -l " +$" {} \;`
do
    perl -p -i -e 's/\s+$/\n/' $FILE
    git add "$FILE"
done

# The rest of this is for running lein test
color_normal="\033[0m"
color_white="\033[;1m"
color_green="\033[32m"
color_yellow="\033[33m"
color_red="\033[31m"

_print() {
    echo "${color_white}[pre-commit hook]${color_normal} $1"
}

_info() {
    _print "$1"
}

_success() {
    _print "${color_green}$1${color_normal}"
}

_warn() {
    _print "${color_yellow}$1${color_normal}"
}

_error() {
    _print "${color_red}$1${color_normal}"
}


_checkCode() {
    errors=$(lein check 2>&1 > /dev/null)
    if [ ! $? = 0 ] ; then
        _error "Syntax check failed:"
        if [ true ] ; then
            error=$(head -n1 <<< "$errors")
            _error "$error"
        fi
        exit 1
    fi

    errors=$(lein test 2> /dev/null)
    if [ ! $? = 0 ] ; then
        _error "Tests failed:"
        if [ true ] ; then
            error=$(grep "^FAIL" <<< "$errors")
            _error "$error"
        fi
        exit 1
    fi

    _success "Code check passed."
}

_checkDocumentation() {
    # Check if metadata (:added, :deprecated, :io, :pure, ...) is accurate

    _success "Documentation check passed."
}

_info "Running..."
_checkCode
_checkDocumentation
_info "Finished."
